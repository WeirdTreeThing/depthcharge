# SPDX-License-Identifier: GPL-2.0

testsrc = $(src)/tests
testobj = $(obj)/tests
objutil = $(obj)/util
objext = $(obj)/external

# Set default path for EC_HEADERS if provided does not contain ec_headers.h
EC_HEADERS ?= ../../src/ec/google/chromeec
ifeq ($(wildcard $(EC_HEADERS)/ec_commands.h),)
EC_HEADERS = ../ec/include
endif
ifeq ($(wildcard $(EC_HEADERS)/ec_commands.h),)
$(error Please set EC_HEADERS= to directory containing ec_commands.h!)
endif

# Libpayload source directory in the coreboot project
LP_SOURCE ?= ../libpayload
ifeq ($(wildcard $(LP_SOURCE)),)
# If directory pointed by LP_SOURCE is empty then assume libpayload
# is in the Chromium OS SDK coreboot directory
LP_SOURCE = ../../third_party/coreboot/payloads/libpayload
endif
ifeq ($(wildcard $(LP_SOURCE)),)
$(error Please set LP_SOURCE= to directory containing libpayload sources!)
endif

libpayloadsrc = $(LP_SOURCE)
libpayloadobj = $(objext)/libpayload
vbootobj = $(objext)/vboot

LIBPAYLOAD_LIB = $(libpayloadobj)/libpayload.a
LIBPAYLOAD_LIBC_LIB = $(libpayloadobj)/libc.a
VBOOT_LIB = $(vbootobj)/vboot_fw.a
TLCL_LIB = $(vbootobj)/tlcl.a

LIBPAYLOAD_DEFCONFIG := $(libpayloadsrc)/configs/defconfig
LIBPAYLOAD_DOTCONFIG := $(libpayloadobj)/.config
LIBPAYLOAD_KCONFIG_AUTOHEADER := $(libpayloadobj)/config.h
LIBPAYLOAD_KCONFIG_AUTOCONFIG := $(libpayloadobj)/auto.conf
LIBPAYLOAD_KCONFIG_DEPENDENCIES := $(libpayloadobj)/auto.conf.cmd
LIBPAYLOAD_KCONFIG_SPLITCONFIG := $(libpayloadobj)/config
LIBPAYLOAD_KCONFIG_TRISTATE := $(libpayloadobj)/tristate.conf
LIBPAYLOAD_CONFIG := $(libpayloadobj)/libpayload-config.h

CMAKE := cmake
OBJCOPY ?= objcopy

TEST_CFLAGS = -m32
TEST_LDFLAGS = -m32

# Include generic test mock headers, before original ones
TEST_CFLAGS += -I$(testsrc)/include/mocks -I$(testsrc)/include

# Depthcharge includes
TEST_CFLAGS += -I$(obj) -I$(src)/src -I$(src)/src/arch/x86/includes/

# vboot_reference and ec-headers
TEST_CFLAGS += -I$(VB_SOURCE)/firmware/include -I$(EC_HEADERS)

# Libpayload flags
TEST_CFLAGS += -D__LIBPAYLOAD__=1
TEST_CFLAGS += -I$(libpayloadobj)
TEST_CFLAGS += -I$(libpayloadsrc)/include -I $(libpayloadsrc)/include/x86
TEST_CFLAGS += -include $(libpayloadsrc)/include/kconfig.h
TEST_CFLAGS += -include $(libpayloadsrc)/include/compiler.h

# Note: This is intentionally just a subset of the warnings in the toplevel
# Makefile.inc. We don't need to be as strict with test code, and things like
# -Wmissing-prototypes just make working with the test framework cumbersome.
# Only put conservative warnings here that really detect code that's obviously
# unintentional.
TEST_CFLAGS += -Wall -Werror -Wundef -Wstrict-prototypes

TEST_CFLAGS += -std=gnu11 -Os
TEST_CFLAGS += -ffunction-sections -fdata-sections -fno-builtin

TEST_LDFLAGS += -Wl,--gc-sections -no-pie

# Extra attributes for unit tests, declared per test
attributes := srcs cflags config mocks

alltests :=
subdirs := tests/arch tests/base tests/board tests/boot tests/debug \
	tests/diag tests/drivers tests/image tests/net tests/netboot tests/vboot

define tests-handler
alltests += $(1)$(2)
$(foreach attribute,$(attributes),
	$(eval $(1)$(2)-$(attribute) += $($(2)-$(attribute))))
$(foreach attribute,$(attributes),
	$(eval $(2)-$(attribute):= ))
endef

$(call add-special-class, tests)
$(call evaluate_subdirs)

# Create actual targets for unit test binaries
# $1 - test name
#
# Generate config file using values provided in $(1)-config property.
# Add required libraries if requested by $(1)-props.
# Enable wrapping of mocked symbols
define TEST_CC_template
$(1)-config-file := $(obj)/$(1)/config.h
$$($(1)-config-file):
	mkdir -p $$(dir $$@)
	printf '// File generated by tests/Makefile.inc\n// Do not change\n' > $$@
	for kv in $$($(1)-config); do \
		key="`echo $$$$kv | cut -d '=' -f -1`"; \
		value="`echo $$$$kv | cut -d '=' -f 2-`"; \
		printf '#undef %s\n' "$$$$key" >> $$@; \
		printf '#define %s %s\n\n' "$$$$key" "$$$$value" >> $$@; \
	done

$($(1)-srcobjs): OBJCOPY_FLAGS += $$(foreach mock,$$($(1)-mocks), \
	--globalize-symbol=$$(mock) --weaken-symbol=$$(mock))
$($(1)-objs): TEST_CFLAGS += -I$$(dir $$($(1)-config-file))
$($(1)-objs): $(obj)/$(1)/%.o: $$$$*.c $$($(1)-config-file) $(LIBPAYLOAD_CONFIG)
	@printf "    CC       $$(subst $$(obj)/,,$$(@))\n"
	mkdir -p $$(dir $$@)
	$(HOSTCC) $(HOSTCFLAGS) $$(TEST_CFLAGS) $($(1)-cflags)  -MMD \
		-MT $$@ -c $$< -o $$@.orig
	@printf "    OBJCOPY  $$(subst $$(obj)/,,$$(@))\n"
	$(OBJCOPY) $$@.orig $$(OBJCOPY_FLAGS) $$@

$(1)-vboot := $(obj)/$(1)/$$(notdir $(VBOOT_LIB))
$$($(1)-vboot): $(VBOOT_LIB)
	mkdir -p $$(dir $$@)
	$(OBJCOPY) $$^ $$(foreach mock,$$($(1)-mocks), \
		--globalize-symbol=$$(mock) --weaken-symbol=$$(mock)) $$@

$(1)-tlcl := $(obj)/$(1)/$$(notdir $(TLCL_LIB))
$$($(1)-tlcl): $(TLCL_LIB)
	mkdir -p $$(dir $$@)
	$(OBJCOPY) $$^ $$(foreach mock,$$($(1)-mocks), \
		--globalize-symbol=$$(mock) --weaken-symbol=$$(mock)) $$@

$($(1)-bin): $($(1)-objs) $(LIBPAYLOAD_LIB) $$($(1)-vboot) $$($(1)-tlcl) $(LIBPAYLOAD_LIBC_LIB)
	@printf "    CC       $$(subst $$(obj)/,,$$(@))\n"
	mkdir -p $$(dir $$@)
	$(HOSTCC) $$(TEST_LDFLAGS) -lcmocka $$^ \
		-Wl,--exclude-libs,ALL -lc $($(1)-cflags) -o $$@
endef

$(foreach test, $(alltests), \
	$(eval $(test)-srcobjs := $(addprefix $(obj)/$(test)/, \
		$(patsubst %.c,%.o,$(filter src/%,$($(test)-srcs))))) \
	$(eval $(test)-objs := $(addprefix $(obj)/$(test)/, \
		$(patsubst %.c,%.o,$($(test)-srcs))))\
	$(eval $(test)-objs += $(addprefix $(obj)/$(test)/, \
		$(patsubst %.c,%.o,tests/stubs/die.c tests/stubs/heap.c))))
$(foreach test, $(alltests), \
	$(eval $(test)-bin := $(obj)/$(test)/run))
$(foreach test, $(alltests), \
	$(eval $(call TEST_CC_template,$(test))))
$(foreach test, $(alltests), \
	$(eval all-test-objs += $($(test)-objs)))
$(foreach test, $(alltests), \
	$(eval test-bins += $($(test)-bin)))

DEPENDENCIES += $(addsuffix .d,$(basename $(all-test-objs)))
-include $(DEPENDENCIES)

# Configure and build libpayload from sources
$(LIBPAYLOAD_DOTCONFIG):
	mkdir -p $(dir $@)
	cp $(LIBPAYLOAD_DEFCONFIG) $@
	printf '\nCONFIG_LP_CHROMEOS=y\n' >> $@
	printf '\nCONFIG_LP_ARCH_X86=y\n' >> $@

$(LIBPAYLOAD_KCONFIG_AUTOHEADER): LIBPAYLOAD_KCONFIG_FLAGS:= \
	DOTCONFIG=$(LIBPAYLOAD_DOTCONFIG) \
	KCONFIG_AUTOHEADER=$(LIBPAYLOAD_KCONFIG_AUTOHEADER) \
	KCONFIG_AUTOCONFIG=$(LIBPAYLOAD_KCONFIG_AUTOCONFIG) \
	KCONFIG_DEPENDENCIES=$(LIBPAYLOAD_KCONFIG_DEPENDENCIES) \
	KCONFIG_SPLITCONFIG=$(LIBPAYLOAD_KCONFIG_SPLITCONFIG) \
	KCONFIG_TRISTATE=$(LIBPAYLOAD_KCONFIG_TRISTATE) \
	KBUILD_DEFCONFIG=$(LIBPAYLOAD_DEFCONFIG)

$(LIBPAYLOAD_KCONFIG_AUTOHEADER): $(LIBPAYLOAD_DOTCONFIG)
	mkdir -p $(dir $@)
	+$(MAKE) $(LIBPAYLOAD_KCONFIG_FLAGS) -C $(libpayloadsrc) \
		obj=$(libpayloadobj) olddefconfig
	+$(MAKE) $(LIBPAYLOAD_KCONFIG_FLAGS) -C $(libpayloadsrc) \
		obj=$(libpayloadobj) silentoldconfig

$(LIBPAYLOAD_LIB): $(LIBPAYLOAD_KCONFIG_AUTOHEADER)
	@printf "    MAKE       $(subst $(obj)/,,$(@))\n"
	+$(MAKE) CC=$(HOSTCC) CXX=$(HOSTCXX) AR=$(HOSTAR) -C $(libpayloadsrc) \
		EXTRA_CFLAGS=-m32 obj=$(libpayloadobj) \
		DOTCONFIG=$(LIBPAYLOAD_DOTCONFIG) V=$(V)

$(LIBPAYLOAD_CONFIG): $(LIBPAYLOAD_KCONFIG_AUTOHEADER)
	mkdir -p $(dir $@)
	cp $< $@

$(LIBPAYLOAD_LIBC_LIB): $(LIBPAYLOAD_LIB)

# Build vboot
$(VBOOT_LIB):
	@printf "    MAKE       $(subst $(obj)/,,$(@))\n"
	FIRMWARE_ARCH= \
		CC="$(HOSTCC)" \
		CFLAGS="-m32 -DVBOOT_DEBUG" \
		$(MAKE) -C $(VB_SOURCE) \
		MOCK_TPM=n \
		TPM2_MODE=y \
		BOOT_EXTERNAL_ON_DEV=n \
		EC_SLOW_UPDATE=y \
		EC_EFS=n \
		DETACHABLE=n \
		DIAGNOSTIC_UI=y \
		PHYSICAL_PRESENCE_KEYBOARD=y \
		CUSTOM_MUSIC=n \
		UNROLL_LOOPS=1 \
		BUILD=$(vbootobj) \
		V=$(V) \
		$(vbootobj)/vboot_fw.a tlcl

$(TLCL_LIB): $(VBOOT_LIB)

.PHONY: $(alltests) $(addprefix clean-,$(alltests))
.PHONY: unit-tests build-unit-tests run-unit-tests clean-unit-tests
.PHONY: list-unit-tests help-unit-tests

ifeq ($(JUNIT_OUTPUT),y)
$(alltests): export CMOCKA_MESSAGE_OUTPUT=xml
$(alltests): export CMOCKA_XML_FILE=$(testobj)/junit-$(subst /,_,$^)-%g.xml
endif

$(alltests): $$($$(@)-bin)
	rm -f $(testobj)/junit-$(subst /,_,$^)-*.xml $(testobj)/$(subst /,_,$^).failed
	$^ || echo failed > $(testobj)/$(subst /,_,$^).failed

unit-tests: build-unit-tests run-unit-tests

build-unit-tests: $(test-bins)

run-unit-tests: $(alltests)
	if [ `find $(testobj) -name '*.failed' | wc -l` -gt 0 ]; then \
		echo "**********************"; \
		echo "     TESTS FAILED     "; \
		echo "**********************"; \
		exit 1; \
	else \
		echo "**********************"; \
		echo "   ALL TESTS PASSED   "; \
		echo "**********************"; \
		exit 0; \
	fi

$(addprefix clean-,$(alltests)): clean-%:
	rm -rf $(obj)/$*

clean-unit-tests:
	rm -rf $(testobj)

list-unit-tests:
	@echo "unit-tests:"
	for t in $(sort $(alltests)); do \
		echo "  $$t"; \
	done

help-unit-tests::
	@echo  '*** unit-tests targets ***'
	@echo  '  unit-tests            - Run all unit-tests from tests/'
	@echo  '  clean-unit-tests      - Remove unit-tests build artifacts'
	@echo  '  list-unit-tests       - List all unit-tests'
	@echo  '  <unit-test>           - Build and run single unit-test'
	@echo  '  clean-<unit-test>     - Remove single unit-test build artifacts'
	@echo
